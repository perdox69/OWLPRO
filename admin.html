<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a237e;
            --accent: #00e5ff;
            --bg: #f4f7fa;
            --white: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --radius: 16px;
        }

        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 1.8rem; }
        .header-actions button {
            border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .btn-refresh { background: var(--primary); color: white; }
        .btn-qr { background: var(--white); color: var(--primary); border: 2px solid var(--primary) !important; margin-right: 10px; }

        /* KPI Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .stat-title { color: #757575; font-size: 0.9rem; font-weight: 500; margin-bottom: 10px; }
        .stat-value { font-size: 2.2rem; font-weight: 700; color: var(--primary); }
        .stat-icon { font-size: 2rem; margin-bottom: 10px; color: var(--accent); }

        /* Charts Section */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); }
        .chart-title { font-weight: 600; margin-bottom: 15px; color: var(--primary); }
        
        @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }

        /* Table Section */
        .table-card { background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; color: #757575; border-bottom: 2px solid #eee; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid #f9f9f9; font-size: 0.95rem; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-student { background: #e3f2fd; color: #1565c0; }
        .badge-staff { background: #e8f5e9; color: #2e7d32; }
        
        .btn-del { background: #ffebee; color: #c62828; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-del:hover { background: #ffcdd2; }

        /* QR Modal */
        #qrModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 350px; }
        .modal-content img { width: 100%; border-radius: 10px; margin-bottom: 20px; }
        .close-btn { background: #eee; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üìä Dashboard ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</h1>
        <div class="header-actions">
            <button class="btn-qr" onclick="toggleQR()">üì± QR Code</button>
            <button class="btn-refresh" onclick="fetchData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-title">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value" id="totalBookings">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° (‡∏Ñ‡∏ô)</div>
            <div class="stat-value" id="totalUsers">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-title">‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
            <div class="stat-value" id="topRoom" style="font-size: 1.2rem;">-</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û)</div>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="chart-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div>
            <canvas id="roomChart"></canvas>
        </div>
    </div>

    <div class="table-card">
        <div class="chart-title" style="margin-bottom: 20px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div id="loading" style="text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>‡∏´‡πâ‡∏≠‡∏á</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û / ‡∏Ñ‡∏ì‡∏∞</th>
                    <th>‡∏Ñ‡∏ô / ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="qrModal">
    <div class="modal-content">
        <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</h3>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://perdox69.github.io/OWLPRO/index.html" alt="QR">
        <button class="close-btn" onclick="toggleQR()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>
</div>

<script>
    // üî¥üî¥üî¥ 1. ‡πÉ‡∏™‡πà URL ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Apps Script ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏á Deploy ‡∏Ñ‡∏£‡∏±‡∏ö üî¥üî¥üî¥
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyxCQVNd_dGkjKYX8LBfQYHSyILOvRgNqlVZdd6HIB9bk8TRJwsPS9mhf989TPQKNHkxQ/exec";

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
    let statusChartInstance = null;
    let roomChartInstance = null;

    async function fetchData() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('tableBody').innerHTML = '';
        
        try {
            const res = await fetch(WEB_APP_URL);
            const data = await res.json();
            
            updateStats(data);
            renderCharts(data);
            renderTable(data);
        } catch(e) { 
            console.error(e); 
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ URL ‡∏´‡∏£‡∏∑‡∏≠ Internet");
        } finally { 
            document.getElementById('loading').style.display = 'none'; 
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    function updateStats(data) {
        // 1. ‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á‡∏£‡∏ß‡∏°
        document.getElementById('totalBookings').innerText = data.length;

        // 2. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å column users)
        const totalPeople = data.reduce((sum, item) => sum + (parseInt(item.users) || 0), 0);
        document.getElementById('totalUsers').innerText = totalPeople;

        // 3. ‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï
        if(data.length === 0) { document.getElementById('topRoom').innerText = "-"; return; }
        
        const roomCount = {};
        data.forEach(item => { roomCount[item.room] = (roomCount[item.room] || 0) + 1; });
        
        // ‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î
        const top = Object.entries(roomCount).reduce((a, b) => a[1] > b[1] ? a : b);
        // ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ
        let shortName = top[0].split('(')[0]; 
        document.getElementById('topRoom').innerText = shortName;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    function renderCharts(data) {
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û
        const statusCount = {};
        data.forEach(item => { statusCount[item.status] = (statusCount[item.status] || 0) + 1; });

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡πâ‡∏≠‡∏á
        const roomCount = {};
        data.forEach(item => { 
            let simpleName = item.room.split('(')[0].trim(); // ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô
            roomCount[simpleName] = (roomCount[simpleName] || 0) + 1; 
        });

        // Setup ‡∏Å‡∏£‡∏≤‡∏ü 1: Pie Chart
        const ctx1 = document.getElementById('statusChart').getContext('2d');
        if(statusChartInstance) statusChartInstance.destroy(); // ‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
        
        statusChartInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCount),
                datasets: [{
                    data: Object.values(statusCount),
                    backgroundColor: ['#42a5f5', '#66bb6a', '#ffa726', '#ef5350'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '70%', plugins: { legend: { position: 'right' } } }
        });

        // Setup ‡∏Å‡∏£‡∏≤‡∏ü 2: Bar Chart
        const ctx2 = document.getElementById('roomChart').getContext('2d');
        if(roomChartInstance) roomChartInstance.destroy();

        roomChartInstance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(roomCount),
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á',
                    data: Object.values(roomCount),
                    backgroundColor: '#1a237e',
                    borderRadius: 5
                }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
        data.sort((a,b) => a.room.localeCompare(b.room) || a.startMin - b.startMin);

        data.forEach(item => {
            const badgeClass = item.status === '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤' ? 'badge-student' : 'badge-staff';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:600; color:#1a237e;">${item.room}</td>
                <td>${item.timeRange}</td>
                <td>
                    ${item.name || '-'}<br>
                    <small style="color:#999;">${item.phone || '-'}</small>
                </td>
                <td>
                    <span class="status-badge ${badgeClass}">${item.status || '-'}</span><br>
                    <small style="color:#666;">${item.faculty || ''}</small>
                </td>
                <td>
                    üë§ ${item.users || '-'} ‡∏Ñ‡∏ô<br>
                    <small style="color:#666;">${item.usage || '-'}</small>
                </td>
                <td>
                    <button class="btn-del" onclick="deleteItem('${item.id}', this)">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function deleteItem(id, btn) {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
        btn.innerText = "..."; btn.disabled = true;

        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('id', id);

        fetch(WEB_APP_URL, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'deleted') {
                // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà
                btn.closest('tr').remove();
                fetchData(); 
            } else {
                alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); btn.innerText = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"; btn.disabled = false;
            }
        });
    }

    function toggleQR() {
        const el = document.getElementById('qrModal');
        el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    fetchData();
</script>
</body>
</html>