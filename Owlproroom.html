<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î (Cloud Sync)</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2c3e50; }
        .loader { text-align: center; color: #e67e22; font-weight: bold; display: none; margin-bottom: 10px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }

        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px; }
        .time-slot { padding: 10px 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer; font-size: 13px; background: white; }
        
        .time-slot.disabled { background: #eee; color: #aaa; cursor: not-allowed; text-decoration: line-through; }
        .time-slot.selected { background: #2980b9; color: white; border-color: #2980b9; }
        .time-slot.range { background: #d6eaf8; border-color: #3498db; color: #2980b9; }

        .btn-submit { width: 100%; padding: 15px; background-color: #27ae60; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 20px; font-weight: bold; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }

        #yearGroup { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìö ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î Real-time</h1>
    <div id="loading" class="loader">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <div class="form-group"><label>1. ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="inpName"></div>
    <div class="form-group"><label>2. ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label><input type="tel" id="inpPhone"></div>
    <div class="form-group">
        <label>3. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û *</label>
        <select id="inpStatus" onchange="toggleYear()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option value="‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
            <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
            <option value="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
    </div>
    <div class="form-group" id="yearGroup">
        <label>4. ‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
        <select id="inpYear">
            <option value="">-</option>
            <option value="‡∏õ‡∏µ 1">‡∏õ‡∏µ 1</option><option value="‡∏õ‡∏µ 2">‡∏õ‡∏µ 2</option>
            <option value="‡∏õ‡∏µ 3">‡∏õ‡∏µ 3</option><option value="‡∏õ‡∏µ 4">‡∏õ‡∏µ 4</option>
        </select>
    </div>
    <div class="form-group">
        <label>5. ‡∏Ñ‡∏ì‡∏∞/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô *</label>
        <select id="inpFaculty">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option value="‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
            <option value="‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏Ø">‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏Ø</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
    </div>

    <hr>
    <div class="form-group">
        <label>6. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á *</label>
        <select id="inpRoom" onchange="fetchAndRender()">
            <option value="Sharing Room (‡∏ä‡∏±‡πâ‡∏ô 1)">Sharing Room (‡∏ä‡∏±‡πâ‡∏ô 1) (07.30 - 19.00)</option>
            <option value="Library Cafe (‡∏ä‡∏±‡πâ‡∏ô 2)">Library Cafe (‡∏ä‡∏±‡πâ‡∏ô 2) (08.30 - 16.30)</option>
        </select>
    </div>

    <div class="form-group">
        <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (3 ‡∏ä‡∏°.):</label>
        <div id="grid" class="grid-container"></div>
        <div id="preview" style="text-align:center; margin-top:10px; font-weight:bold; color:#2980b9;"></div>
    </div>

    <button id="btnSubmit" class="btn-submit" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
</div>

<script>
    // üî¥üî¥üî¥ ‡πÄ‡∏≠‡∏≤ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 10 ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üî¥üî¥üî¥
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz4IlXb1G6HhAV1py2ROKDtMYPDSZxPyNf_Txlj6YwQAU1lcEyC2PWvPOfRiiOTb2BYTg/exec";

    const BOOKING_DURATION = 180; 
    const ROOM_CONFIG = {
        "Sharing Room (‡∏ä‡∏±‡πâ‡∏ô 1)": { start: 450, end: 1140 },
        "Library Cafe (‡∏ä‡∏±‡πâ‡∏ô 2)": { start: 510, end: 990 }
    };
    
    let dbBookings = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Sheet
    let selectedStart = null;

    function toggleYear() {
        document.getElementById('yearGroup').style.display = 
            document.getElementById('inpStatus').value === '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤' ? 'block' : 'none';
    }

    function minToStr(min) {
        let h = Math.floor(min/60), m = min%60;
        return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
    }

    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets (Sync)
    async function fetchAndRender() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('grid').innerHTML = ''; // Clear old

        try {
            // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet
            const response = await fetch(WEB_APP_URL);
            dbBookings = await response.json(); 
            
            renderGrid(); // ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        } catch (error) {
            alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            console.error(error);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    function renderGrid() {
        const room = document.getElementById('inpRoom').value;
        const cfg = ROOM_CONFIG[room];
        const container = document.getElementById('grid');
        container.innerHTML = '';
        selectedStart = null;
        document.getElementById('preview').innerText = '';

        for(let m = cfg.start; m < cfg.end; m += 30) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ ‡πÉ‡∏ô Sheet ‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏à‡∏≠‡∏á‡∏¢‡∏±‡∏á?
            const isBooked = dbBookings.filter(b => b.room === room).some(b => m >= b.startMin && m < b.endMin);
            const isLate = (m + BOOKING_DURATION) > cfg.end;
            
            const btn = document.createElement('div');
            btn.className = `time-slot ${isBooked ? 'disabled' : ''} ${isLate ? 'disabled' : ''}`;
            btn.innerText = minToStr(m);
            if(!isBooked && !isLate) btn.onclick = () => selectTime(m);
            
            container.appendChild(btn);
        }
    }

    function selectTime(start) {
        selectedStart = start;
        const end = start + BOOKING_DURATION;
        document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected', 'range'));
        
        const room = document.getElementById('inpRoom').value;
        // Check overlap again (Double check)
        if(dbBookings.filter(b => b.room === room).some(b => start < b.endMin && end > b.startMin)) {
            alert("‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢ ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ä‡∏¥‡∏á‡∏à‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!"); 
            fetchAndRender(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            return;
        }

        // Highlight
        document.querySelectorAll('.time-slot').forEach(btn => {
            const t = parseInt(btn.innerText.split(':')[0])*60 + parseInt(btn.innerText.split(':')[1]);
            if(t === start) btn.classList.add('selected');
            if(t > start && t < end) btn.classList.add('range');
        });

        document.getElementById('preview').innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤: ${minToStr(start)} - ${minToStr(end)}`;
    }

    // 3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    function submitBooking() {
        const name = document.getElementById('inpName').value;
        const phone = document.getElementById('inpPhone').value;
        const status = document.getElementById('inpStatus').value;
        const year = document.getElementById('inpYear').value;
        const faculty = document.getElementById('inpFaculty').value;
        const room = document.getElementById('inpRoom').value;

        if(!name || !phone || !status || !faculty || !selectedStart) { alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }

        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        const end = selectedStart + BOOKING_DURATION;
        const timeRange = `${minToStr(selectedStart)} - ${minToStr(end)}`;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Link ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const url = `${WEB_APP_URL}?name=${encodeURIComponent(name)}&phone=${phone}&status=${status}&year=${year}&faculty=${encodeURIComponent(faculty)}&room=${encodeURIComponent(room)}&startMin=${selectedStart}&endMin=${end}&timeRange=${encodeURIComponent(timeRange)}`;

        // ‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö POST
        fetch(url, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                window.location.reload();
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                btn.disabled = false;
            }
        })
        .catch(err => {
            alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤)");
            window.location.reload();
        });
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
    fetchAndRender();
</script>

</body>
</html>
